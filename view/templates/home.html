<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="initial-scale=1.0">
	<!-- jQuery -->
	<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
	<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<!-- Bootstrap. Change to min for production -->
	<link rel="stylesheet" href="/static/css/bootstrap.css" />
	<link rel="stylesheet" href="/static/css/bootstrap-theme.css" />
	<!-- Date Range Picker -->
	<script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
	<!-- Override bootstrap with custom css -->
	<link rel="stylesheet" href="/static/css/feva.css" />
	<!-- Site title & etc. -->
	<title>Feva</title>
</head>

<body>
<div class="container" id="main-container">
	<!-- Main container -->
	<div class="row" id="header-wrapper">
		<!-- This row should contain the heading and perhaps a navigation bar -->
		<div class="col-md-12">
			<h3 style="font-weight: bold;">Feva - Weather Forcast Accuracy</h3>
		</div>
	</div>

	<div class="row" id="search-bar-wrapper">
		<div class="col-md-12" id="search-components-wrapper">
			<!-- Display city name here -->
			<span id="current-city-label"></span>
			<select id="select-data-type">
				<!-- Types of forecast/observation data to be displayed -->
				<option value="rain">Rainfall</option>
				<option value="temperature">Temperature</option>
				<option value="wind_speed">Wind Speed</option>
				<option value="wind_direction">Wind Direction</option>
				<option value="cloud">Cloud</option>
				<option value="humidity">Humidity</option>
			</select>
			<input type="text" name="daterange" id="date-range-picker" >
			<script type=text/javascript>
				var startDate = new Date(new Date().setDate(new Date().getDate()-7));
				var endDate = new Date;	// Today
				// Configure date range picker
				$('input[name="daterange"]').daterangepicker(
				{
					locale: {
						format: 'YYYY-MM-DD'
					},
					startDate: startDate,
					endDate: endDate
				}, function(start, end, label) {
					console.log("A new date range was chosen: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
					startDate = new Date(start.format('YYYY-MM-DD'));
					endDate = new Date(end.format('YYYY-MM-DD'));
				});
			</script>
			<!-- <label class="search-bar-label">Location:</label> -->
			<input type="text" name="input_location" id="search-box" placeholder="Search for place">
			<input type="text" name="input_location_coord" id="location-coord-box" value="">
			<button id="button-search" onclick="search()">Search</button>
			<!-- Search button action script -->
			<script type=text/javascript>
				function search() {
					// Feva API call to retrieve JSON object
					var e = document.getElementById("select-data-type"),
						data_type = e.options[e.selectedIndex].value,
						lat = $('input[name="input_location_coord"]').val().split(",")[0],
						lon = $('input[name="input_location_coord"]').val().split(",")[1],
						location = $('input[name="input_location"]').val(),
						time = endDate.toISOString().substring(0, 10) + "T08:00:00.0Z",
						max_dist = 10000; // meters

					// alert() is only for debug 
					if (location == '' || location == null) {
						alert("Please select a location");
						return;
					} else {
						alert("Latitude: " + lat + "\n" +
								"Longitude: " + lon + "\n" +
								"Type: " + data_type + "\n" +
								"Max Distance: " + max_dist + "\n" +
								"Time: " + time
						);
					}

					// Clear previous content
					var data_table = document.getElementById("data-table");
					for (i = 1; data_table.rows.length - i > 0; ) {
						data_table.deleteRow(data_table.rows.length - i);
					}

					// Calculate how many days of data to lookup
					var time_span =  Math.ceil(Math.abs(endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24)) + 1;
					for (i = 1; i <= time_span; i++) {
						tr = data_table.insertRow(i);
						tr.id = "data-table-content-row-"+i;
					}

					// Initiate requests for each day
					for (i = 0; i < time_span; i++) {
						time = new Date((new Date).setDate(endDate.getDate()-i));
						displayData(data_type, lat, lon, max_dist, time, i+1);
					}
				}
				// Send API calls
				function makeAPICalls(data_type, lat, lon, max_dist, time, callback){
					// Send search request
					// console.log(data_type, lat, lon, max_dist, time);
					var temp = $.getJSON($SCRIPT_ROOT + 'api/evaluate', {
						weather_type: data_type,
						latitude: lat,
						longitude: lon,
						max_distance: max_dist,
						time: time.toISOString().substring(0, 10) + "T08\:00\:00\.0Z"
					}, function(data) {
						callback(data);
					});
				}
				// Display returned API data and populate the data table
				function displayData(data_type, lat, lon, max_dist, time, row_number){
					//get our JSON
					console.log(data_type, lat, lon, max_dist, time, row_number);
					makeAPICalls(data_type, lat, lon, max_dist, time, function(data){
						//when we get our data, evaluate
						console.log(time.toISOString().substring(0, 10));
						if (data.success == true){
							var unit = "";
							switch (data_type) {
								case "rain":
									unit = "mm";
									break;
								case "temperature":
									unit = "°C";
									break;
								case "wind_speed":
									unit = "km/h"
									break;
								default:
									break;
							}
							// Display valid data
							document.getElementById("data-table-content-row-" + row_number).innerHTML = 
								"<td>" + data.data[0].observation.time.substring(0, 10) + "</td>" + 
								"<td>" + data.data[0].forecast.value + unit + "</td>" +
								"<td>" + data.data[0].observation.value + unit + "</td>" +
								"<td>" + (data.data[0].forecast.value - data.data[0].observation.value) + "</td>";
						} else {
							// Display error
							// console.log(time.toISOString().substring(0, 10) + " : " + data.message);
							document.getElementById("data-table-content-row-" + row_number).innerHTML = 
								"<td>" + time.toISOString().substring(0, 10) + "</td>" +
								"<td>" + "no data" + "</td>" +
								"<td>" + "no data" + "</td>" +
								"<td>" + "-" + "</td>";
						}
					});
				}
			</script>
		</div>
	</div>

	<div class="row" id="main-content-wrapper">
		<!-- This is where main content goes, a giant table of data and an interactive map -->
		<div class="col-md-5" id="data-table-wrapper">
			<!-- A giant table -->
			<table style="width: 100%;" id="data-table">
				<!--title row-->
				<tr style="font-weight: bold;" id="data-table-title-row">
					<td>Date</td>
					<td>Forecast</td>
					<td>Observation</td>
					<td>Δ</td>
				</tr>
				<!--content row(s)-->
			</table>
		</div>
		<div class="col-md-7" id="map-wrapper">
			<!-- An interactive map -->
			<div id="map"></div>
			<!-- Configure map script -->
			<script>
				var map, searchBox, geocoder;
				// Google maps initialiser
				function initMap() {
					map = new google.maps.Map(document.getElementById('map'), {
						zoom: 12,
						mapTypeControlOptions: { mapTypeIds: [] },
						streetViewControl: false,
						zoomControl: false,
					});
					searchBox = new google.maps.places.SearchBox(document.getElementById('search-box'));

					// Create the search box and link it to the UI element.
					var input = document.getElementById('search-box');
					var searchBox = new google.maps.places.SearchBox(input);

					// Bias the SearchBox results towards current map's viewport.
					map.addListener('bounds_changed', function() {
						searchBox.setBounds(map.getBounds());
					});

					var markers = [];
					// Listen for the event fired when the user selects a prediction and retrieve
					// more details for that place.
					searchBox.addListener('places_changed', function() {
						var places = searchBox.getPlaces();

						if (places.length == 0) {
							return;
						}

						// Save location coordinates for later use
						document.getElementById('location-coord-box').value = 
							places[0].geometry.location.lat() + "," + places[0].geometry.location.lng();

						// Clear out the old markers.
						markers.forEach(function(marker) {
							marker.setMap(null);
						});
						markers = [];

						// For each place, get the icon, name and location.
						var bounds = new google.maps.LatLngBounds();
						places.forEach(function(place) {
							// Create a marker for each place.
							markers.push(new google.maps.Marker({
								map: map,
								title: place.name,
								position: place.geometry.location
							}));

							if (place.geometry.viewport) {
								// Only geocodes have viewport.
								bounds.union(place.geometry.viewport);
							} else {
								bounds.extend(place.geometry.location);
							}
						});
						map.fitBounds(bounds);
						search();
					});
					// Focus to users location
					getUserLocation();
					// Display observation points
					addMarkers(map);
				}
				// Get user's location
				function getUserLocation() {
					if (navigator.geolocation) {
						navigator.geolocation.getCurrentPosition(showPosition);
					} else {
						alert("Geolocation is not supported by this browser.");
					}
				}
				// Focus map to user's location
				function showPosition(position) {
					var lat = position.coords.latitude;
					var lng = position.coords.longitude;
					map.setCenter(new google.maps.LatLng(lat, lng));
				}
				var locations = [];
				// Load all forecast/observation location points into an array and load to map
				function addMarkers(map) {
					for (var i = 0; i < locations.length; i++) {
						var loc = locations[i];
						// var icon = {
						// 	url: "../static/images/weather-radar-512.png",
						// 	size: new google.maps.Size(31, 71),
						// 	origin: new google.maps.Point(0, 0),
						// 	anchor: new google.maps.Point(17, 34),
						// 	scaledSize: new google.maps.Size(11, 25)
						// };
						var marker = new google.maps.Marker({
							position: {lat: loc[1], lng: loc[2]},
							// icon: icon,
							map: map,
							title: loc[0],
						});
					}
				}
			</script>
			<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_1pVcpztI11bnkeOehBiFPIVtAT4io9w&libraries=places&callback=initMap" 
				async defer></script>
		</div>
	</div>

	<div class="row" id="footer-wrapper">
		<!-- Footer here -->
		<div class="col-md-12" id="footer">
			<span id="">Copyright 2016, Feva Project Team, All rights reserved.</span>
		</div>
	</div>
	<!-- End of main container -->
</div>
</body>

<!-- bootstrap -->
<script src="/static/js/bootstrap.js"></script>
<!-- Flask -->
<script type=text/javascript>
	var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>

</html>
